<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - FidduPay</title>
    <meta name="description" content="Secure cryptocurrency payment powered by FidduPay">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-xl shadow-2xl overflow-hidden fade-in">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 text-center">
            <div class="flex items-center justify-center mb-2">
                <svg class="w-8 h-8 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
                </svg>
                <h1 class="text-xl font-bold">FidduPay</h1>
            </div>
            <p class="text-sm opacity-90">Secure Crypto Payment</p>
            <p class="text-xs opacity-75 mt-1">ID: {{payment_id}}</p>
        </div>

        <!-- Status Badge -->
        <div class="p-6 text-center border-b border-gray-100">
            {{#if (eq status "PENDING")}}
            <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 pulse">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                Awaiting Payment
            </div>
            {{/if}}
            {{#if (eq status "CONFIRMING")}}
            <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-blue-100 text-blue-800 pulse">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                </svg>
                Confirming Payment
            </div>
            {{/if}}
            {{#if (eq status "CONFIRMED")}}
            <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                Payment Confirmed
            </div>
            {{/if}}
            {{#if (eq status "EXPIRED")}}
            <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-red-100 text-red-800">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                Payment Expired
            </div>
            {{/if}}
            {{#if (eq status "FAILED")}}
            <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-red-100 text-red-800">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                Payment Failed
            </div>
            {{/if}}
        </div>

        <!-- Amount Display -->
        <div class="p-6">
            <div class="bg-gray-50 rounded-xl p-6 text-center mb-6">
                <p class="text-sm text-gray-600 mb-2">Amount to Pay</p>
                <p class="text-3xl font-bold text-gray-900 mb-1">{{amount}} {{crypto_type}}</p>
                <p class="text-lg text-gray-500">${{amount_usd}} USD</p>
                {{#if fee_amount_usd}}
                <p class="text-xs text-gray-400 mt-2">Includes ${{fee_amount_usd}} processing fee</p>
                {{/if}}
            </div>

            {{#if (eq status "PENDING")}}
            <!-- QR Code -->
            <div class="mb-6 flex justify-center">
                <div class="bg-white p-4 rounded-xl border-2 border-gray-200 shadow-sm">
                    <img src="data:image/png;base64,{{qr_code}}" alt="Payment QR Code" class="w-48 h-48">
                </div>
            </div>

            <!-- Payment Address -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Send to Address</label>
                <div class="flex items-center space-x-2">
                    <input type="text" readonly value="{{to_address}}" 
                        class="flex-1 px-3 py-3 border border-gray-300 rounded-lg text-sm font-mono bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        id="address-input">
                    <button onclick="copyAddress()" 
                        class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Network Info -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex items-start space-x-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-sm text-blue-800">
                        <p class="font-medium">Network: {{network}}</p>
                        <p class="mt-1">Send only {{crypto_type}} on {{network}} network. Other tokens will be lost.</p>
                        {{#if confirmations}}
                        <p class="mt-1">Confirmations: {{confirmations}}/{{required_confirmations}}</p>
                        {{/if}}
                    </div>
                </div>
            </div>

            <!-- Timer -->
            <div class="text-center">
                <p class="text-sm text-gray-600 mb-1">Time Remaining</p>
                <p class="text-2xl font-bold text-gray-900" id="timer">Loading...</p>
            </div>
            {{/if}}

            {{#if (eq status "CONFIRMED")}}
            <!-- Success Message -->
            <div class="p-4 bg-green-50 rounded-lg border border-green-200 text-center">
                <svg class="w-12 h-12 text-green-600 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <p class="text-green-800 font-medium text-lg">Payment Confirmed!</p>
                <p class="text-sm text-green-600 mt-2">Your payment has been successfully processed.</p>
                {{#if transaction_hash}}
                <p class="text-xs text-green-600 mt-2 font-mono break-all">TX: {{transaction_hash}}</p>
                {{/if}}
                {{#if confirmed_at}}
                <p class="text-xs text-green-600 mt-1">Confirmed: {{confirmed_at}}</p>
                {{/if}}
            </div>
            {{/if}}

            {{#if (eq status "EXPIRED")}}
            <!-- Expired Message -->
            <div class="p-4 bg-red-50 rounded-lg border border-red-200 text-center">
                <svg class="w-12 h-12 text-red-600 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <p class="text-red-800 font-medium text-lg">Payment Expired</p>
                <p class="text-sm text-red-600 mt-2">This payment request has expired. Please contact the merchant for a new payment link.</p>
            </div>
            {{/if}}

            {{#if (eq status "FAILED")}}
            <!-- Failed Message -->
            <div class="p-4 bg-red-50 rounded-lg border border-red-200 text-center">
                <svg class="w-12 h-12 text-red-600 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <p class="text-red-800 font-medium text-lg">Payment Failed</p>
                <p class="text-sm text-red-600 mt-2">This payment could not be processed. Please try again or contact support.</p>
            </div>
            {{/if}}
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 text-center border-t border-gray-100">
            <p class="text-xs text-gray-500">Powered by FidduPay</p>
            {{#if sandbox}}
            <p class="text-xs text-yellow-600 font-medium mt-1">⚠️ SANDBOX MODE - Test Payment</p>
            {{/if}}
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="spinner w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-700">Checking payment status...</p>
        </div>
    </div>

    <script>
        var copyTimeout;
        var timerInterval;
        var statusInterval;
        
        function copyAddress() {
            var input = document.getElementById('address-input');
            if (!input) return;
            
            var button = input.nextElementSibling;
            
            input.select();
            input.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                button.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
                button.classList.add('bg-green-600');
                button.classList.remove('bg-blue-600');
                
                clearTimeout(copyTimeout);
                copyTimeout = setTimeout(function() {
                    button.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/></svg>';
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-blue-600');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy address:', err);
            }
        }

        function updateTimer() {
            var expiresAt = new Date('{{expires_at}}').getTime();
            var now = new Date().getTime();
            var distance = expiresAt - now;
            var timerElement = document.getElementById('timer');
            
            if (!timerElement) return;
            
            if (distance < 0) {
                timerElement.textContent = 'Expired';
                timerElement.classList.add('text-red-600');
                return;
            }
            
            var hours = Math.floor(distance / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            var timeString = '';
            if (hours > 0) timeString += hours + 'h ';
            timeString += minutes + 'm ' + seconds + 's';
            
            timerElement.textContent = timeString;
            
            if (distance < 300000) {
                timerElement.classList.add('text-red-600');
            } else if (distance < 900000) {
                timerElement.classList.add('text-yellow-600');
            }
        }
        
        function checkPaymentStatus() {
            var overlay = document.getElementById('loading-overlay');
            
            try {
                overlay.classList.remove('hidden');
                
                fetch(window.location.href + '/status')
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.status !== 'PENDING') {
                            clearInterval(timerInterval);
                            clearInterval(statusInterval);
                            window.location.reload();
                        }
                    })
                    .catch(function(e) {
                        console.error('Failed to check payment status:', e);
                    })
                    .finally(function() {
                        overlay.classList.add('hidden');
                    });
            } catch (e) {
                console.error('Status check error:', e);
                overlay.classList.add('hidden');
            }
        }

        // Initialize for pending payments only
        var paymentStatus = '{{status}}';
        if (paymentStatus === 'PENDING') {
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            statusInterval = setInterval(checkPaymentStatus, 5000);
        }

        // Security measures
        document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
        document.addEventListener('selectstart', function(e) {
            if (e.target.id !== 'address-input') e.preventDefault();
        });
    </script>
</body>
</html>
