<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Crypto Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Payment Request</h1>
            <p class="text-sm text-gray-500 mt-1">{{payment_id}}</p>
        </div>

        <!-- Status Badge -->
        <div class="mb-6 text-center">
            {{#if is_pending}}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                ⏳ Awaiting Payment
            </span>
            {{/if}}
            {{#if is_confirmed}}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                ✓ Payment Confirmed
            </span>
            {{/if}}
            {{#if is_expired}}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                ✗ Payment Expired
            </span>
            {{/if}}
        </div>

        <!-- Amount Display -->
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
            <div class="text-center">
                <p class="text-sm text-gray-600 mb-1">Amount to Pay</p>
                <p class="text-3xl font-bold text-gray-900">{{amount}} {{crypto_type}}</p>
                <p class="text-sm text-gray-500 mt-1">${{amount_usd}} USD</p>
            </div>
        </div>

        {{#if is_pending}}
        <!-- QR Code -->
        <div class="mb-6 flex justify-center">
            <div class="bg-white p-4 rounded-lg border-2 border-gray-200">
                <img src="data:image/png;base64,{{qr_code}}" alt="Payment QR Code" class="w-48 h-48">
            </div>
        </div>

        <!-- Payment Address -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Send to Address</label>
            <div class="flex items-center space-x-2">
                <input type="text" readonly value="{{deposit_address}}" 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm font-mono bg-gray-50"
                    id="address-input">
                <button onclick="copyAddress()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
                    Copy
                </button>
            </div>
        </div>

        <!-- Network Info -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <p class="text-sm text-blue-800">
                <strong>Network:</strong> {{network}}<br>
                <strong>Fee:</strong> ${{fee_amount_usd}} USD included
            </p>
        </div>

        <!-- Timer -->
        <div class="mb-6 text-center">
            <p class="text-sm text-gray-600 mb-1">Time Remaining</p>
            <p class="text-2xl font-bold text-gray-900" id="timer">{{time_remaining}}</p>
        </div>
        {{/if}}

        {{#if is_confirmed}}
        <!-- Success Message -->
        <div class="mb-6 p-4 bg-green-50 rounded-lg text-center">
            <p class="text-green-800 font-medium">Payment successfully confirmed!</p>
            <p class="text-sm text-green-600 mt-2">Transaction: {{transaction_hash}}</p>
        </div>
        {{/if}}

        {{#if is_expired}}
        <!-- Expired Message -->
        <div class="mb-6 p-4 bg-red-50 rounded-lg text-center">
            <p class="text-red-800 font-medium">This payment request has expired.</p>
            <p class="text-sm text-red-600 mt-2">Please contact the merchant for a new payment link.</p>
        </div>
        {{/if}}

        <!-- Footer -->
        <div class="text-center text-xs text-gray-500">
            <p>Powered by Crypto Payment Gateway</p>
            {{#if sandbox}}
            <p class="mt-1 text-yellow-600 font-medium">⚠️ SANDBOX MODE - Test Payment</p>
            {{/if}}
        </div>
    </div>

    <script>
        function copyAddress() {
            const input = document.getElementById('address-input');
            input.select();
            document.execCommand('copy');
            alert('Address copied to clipboard!');
        }

        // Countdown timer
        const expiresAt = new Date('{{expires_at}}').getTime();
        
        function updateTimer() {
            const now = new Date().getTime();
            const distance = expiresAt - now;
            
            if (distance < 0) {
                document.getElementById('timer').textContent = 'Expired';
                return;
            }
            
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            document.getElementById('timer').textContent = 
                `${minutes}m ${seconds}s`;
        }
        
        {{#if is_pending}}
        updateTimer();
        setInterval(updateTimer, 1000);
        
        // Poll for payment status every 5 seconds
        setInterval(async () => {
            try {
                const response = await fetch(window.location.href + '/status');
                const data = await response.json();
                if (data.status !== 'PENDING') {
                    window.location.reload();
                }
            } catch (e) {
                console.error('Failed to check payment status:', e);
            }
        }, 5000);
        {{/if}}
    </script>
</body>
</html>
